// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER
// ============================================
model User {
  id           String  @id @default(uuid())
  email        String  @unique
  username     String  @unique
  passwordHash String
  avatarUrl    String?
  bio          String?
  city         String?

  // Auth
  refreshTokens    String[]  @default([])
  resetToken       String?
  resetTokenExpiry DateTime?
  emailVerified    Boolean   @default(false)
  verifyToken      String?

  // Settings (JSON)
  settings Json? @default("{}")

  // Status
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdGroups  ActivityGroup[] @relation("GroupCreator")
  participations Participant[]
  messages       Message[]
  notifications  Notification[]

  @@index([email])
  @@index([username])
  @@index([city])
  @@map("users")
}

// ============================================
// ACTIVITY GROUP
// ============================================
model ActivityGroup {
  id          String   @id @default(uuid())
  title       String
  description String?
  imageUrl    String?
  category    Category
  location    String
  city        String
  date        DateTime
  maxMembers  Int      @default(10)

  // Settings
  isPrivate   Boolean @default(false)
  autoApprove Boolean @default(false)
  isActive    Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creatorId     String
  creator       User           @relation("GroupCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  participants  Participant[]
  messages      Message[]
  notifications Notification[]

  @@index([creatorId])
  @@index([category])
  @@index([city])
  @@index([date])
  @@index([isActive])
  @@index([createdAt])
  @@map("activity_groups")
}

// ============================================
// PARTICIPANT
// ============================================
model Participant {
  id      String            @id @default(uuid())
  status  ParticipantStatus @default(PENDING)
  message String? // Join request message
  role    ParticipantRole   @default(MEMBER)

  // Timestamps
  joinedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userId  String
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId String
  group   ActivityGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@index([status])
  @@map("participants")
}

// ============================================
// MESSAGE
// ============================================
model Message {
  id      String @id @default(uuid())
  content String

  // Media (optional)
  mediaUrl  String?
  mediaType MediaType?

  // Status
  isEdited  Boolean @default(false)
  isDeleted Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  senderId String
  sender   User          @relation(fields: [senderId], references: [id], onDelete: Cascade)
  groupId  String
  group    ActivityGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([groupId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// NOTIFICATION
// ============================================
model Notification {
  id      String           @id @default(uuid())
  type    NotificationType
  title   String
  content String
  isRead  Boolean          @default(false)

  // Timestamps
  createdAt DateTime @default(now())

  // Relations
  userId  String
  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId String?
  group   ActivityGroup? @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([groupId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// ENUMS
// ============================================
enum Category {
  SPORT
  PARTY
  KULTUR
  NATUR
  SOCIAL
  FOOD
  TRAVEL
  GAMING
  OTHER
}

enum ParticipantStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ParticipantRole {
  MEMBER
  MODERATOR
  ADMIN
}

enum NotificationType {
  JOIN_REQUEST
  REQUEST_APPROVED
  REQUEST_REJECTED
  NEW_MESSAGE
  GROUP_UPDATED
  GROUP_DELETED
  MEMBER_LEFT
  REMINDER
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
  FILE
}
